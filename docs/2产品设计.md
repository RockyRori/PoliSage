# 多模态问答系统软件开发方案书

## 特性设计

# PoliSage 产品设计文档

## 一、产品概述

**PoliSage** 是一款基于多模态 RAG（Retrieval-Augmented Generation）技术的智能问答平台，面向校园政策、企业手册等结构化与非结构化文档场景，支持用户将
PDF 文档上传并自动解析为可检索的 JSON 与图片资源。系统利用向量数据库（Qdrant）存储内容，通过智能重排序与可视化渲染，实现高效、精确的问答体验。

## 二、核心功能

1. **文档上传与解析**

    * 支持用户上传 PDF 文件。
    * 使用后端解析引擎将 PDF 转换为：

        * **JSON 结构化块**（包含文本、结构信息）。
        * **图片切片**，并抽取每张图片的 **Caption**。
2. **多模态索引与存储**

    * 将 JSON 文本块编码为向量，存入 Qdrant 向量数据库。
    * 为每个图片生成专属向量并存储，同时将 `caption` 存入 payload。
3. **智能检索与重排序**

    * 接收用户查询，将问题转换为 embedding，检索 top-K 文本/图片片段。
    * 根据查询意图和多模态信号（文本相似度、图像相关度、caption 相关度）进行重排序。
4. **可视化渲染**

    * 前端展示文本和图片碎片。
    * 如果引用中包含图片链接，自动渲染图片；否则只展示纯文本片段。
5. **上下文增强问答**

    * 系统自动拼接相关片段与用户提问，通过大模型（如 GPT-4）生成回答。
    * 支持用户对回答进行反馈，并持续优化检索排序策略。

## 三、用户流程

1. 用户登录 → 进入文档管理页面。
2. 点击 “上传 PDF” → 选择文件 → 系统后台解析并显示解析进度。
3. 解析完成后，前端列表展示所有解析后的条目：JSON 块和图片缩略图。
4. 用户输入查询 → 系统返回相关文本+图片列表 → 前端重排序后渲染。
5. 用户查看答案 → 若需要查看更多细节，可点击 “查看原文” 或在输出中点击图片查看大图。

## 四、系统架构

```
┌────────────┐        ┌──────────┐       ┌──────────┐
│  User/CLI  │  →     │ Frontend │  →    │  Backend │
└────────────┘        └──────────┘       └──────────┘
                                 │             │
                              REST/API         │
                                 │             ↓
                          ┌────────────────────────┐
                          │  Qdrant Vector DB      │
                          └────────────────────────┘
```

* **Frontend**：Vue.js + Naive UI，负责文件上传、列表展示、查询输入与结果渲染。
* **Backend**：Flask 服务，提供：

    * `/files/upload`：接收 PDF 并触发解析。
    * `/files/<filename>`：JSON 与图片静态文件服务。
    * `/chat/query`：检索并生成回答。
* **Vector DB**：Qdrant，用于存储文本与图像向量，支持过滤与高效检索。

## 五、技术选型

| 模块   | 技术/库                  | 说明                    |
|------|-----------------------|-----------------------|
| 前端   | Vue3 + Naive UI       | 响应式页面，弹窗与表格渲染         |
| 后端   | Flask + SQLAlchemy    | 轻量 API 服务，MySQL 存储元数据 |
| 文档解析 | Mineru                | 提取文本与图片               |
| 向量化  | Sentence-Transformers | 文本与图像 embedding       |
| 向量库  | Qdrant                | 支持多模态向量检索与过滤          |
| 生成模型 | OpenAI GPT-4 DeepSeek | RAG 最终生成回答            |

## 六、数据流与实现细节

1. **PDF 解析**

    * 后端定时任务或同步调用 PyMuPDF：切割页面图片 + 提取文本。
    * 生成 JSON 数组，每个对象带有 `type`, `text`, `img_path`, `caption` 等字段。
2. **向量入库**

    * 文本向量：`embed_text(text)` → `PointStruct(vector, payload)`。
    * 图片向量：`embed_image(path)` → `PointStruct(vector, payload) with caption`.
    * 入库时 payload 包含 `filename`, `type`, `caption`。
3. **检索与重排序**

    * 用户查询 encoding → `search()` → 初步按相似度排序。
    * 根据 `payload.type`（text/image）和 `caption` 相似度加权重，二次排序。
4. **前端渲染**

    * 结果返回 JSON 列表，每项有 `payload.text`, `payload.img_path`。
    * 如果 `type==='image'`，则展示 `<img src="…/images/…">`；否则渲染纯文本。

## 七、后续迭代方向

* 支持批注与高亮：用户可对文本/图片片段标注，并存为新的向量。
* 多文档跨源检索：打通多分类文档库，支持标签与权限控制。
* 回答可视化：在回答中嵌入图片 & 文本高亮，提升可读性。
* 在线微调：基于用户反馈，定制检索模型与 reranker。

---

*PoliSage 产品由 RAG 团队设计，旨在打造高效、可视化的多模态智能问答体验。*
